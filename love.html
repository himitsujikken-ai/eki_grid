<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>神羅万象グリッド | 恋愛アルゴリズム解析</title>
<meta name="description" content="マトリックス風恋愛占い。あなたの恋のソースコードをデバッグします。">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    /* --- デザインテーマ：The Matrix Love Grid (基本は同じ、少しピンクを混ぜる?) --- */
    /* 今回は世界観統一のため既存のグリーン基調のままいきます */
    :root {
        --matrix-green: #0F0;
        --matrix-dark: #003300;
        --neon-cyan: #00f2ff;
        --ginza-gold: #c5a059;
        --text-color: #e0e0e0;
        --love-pink: #ff69b4; /* 恋愛用アクセント */
    }

    body {
        font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
        background: #000; margin: 0; padding: 0;
        color: var(--text-color);
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh; overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
    }

    #matrix-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; opacity: 0.8;
    }

    header {
        width: 100%; padding: 40px 20px 20px; text-align: center;
        background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
        z-index: 10;
    }

    h1 {
        font-size: 28px; color: var(--matrix-green);
        text-shadow: 0 0 10px var(--matrix-green);
        margin: 0; letter-spacing: 0.1em; font-family: monospace;
    }
    .subtitle { font-size: 10px; color: #fff; letter-spacing: 0.3em; margin-top: 5px; }

    .intro-text {
        font-size: 13px; line-height: 1.8; max-width: 600px; margin: 20px auto;
        color: #cfcfcf; text-align: left; 
        background: rgba(0, 20, 0, 0.6);
        padding: 15px; border-radius: 4px;
        border-left: 2px solid var(--love-pink); /* ここだけピンクに */
        box-shadow: 0 0 15px rgba(255, 105, 180, 0.2);
    }
    .highlight { color: var(--love-pink); font-weight: bold; }

    /* --- メニュー --- */
    .container {
        width: 90%; max-width: 450px; padding-bottom: 100px;
        display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        z-index: 10;
    }

    .menu-btn {
        position: relative; width: 100%; padding: 25px 10px;
        background: rgba(0, 30, 0, 0.6);
        color: var(--matrix-green);
        border: 1px solid rgba(0, 255, 0, 0.3);
        border-radius: 2px;
        font-family: monospace; font-size: 14px; letter-spacing: 0.05em;
        cursor: pointer; transition: 0.2s;
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.1);
    }
    .menu-btn:active { transform: scale(0.96); background: rgba(0, 255, 0, 0.1); }
    .menu-btn span { display: block; font-size: 10px; opacity: 0.7; margin-top: 5px; color: #fff; }
    .menu-btn.full-width { grid-column: 1 / 3; border-color: var(--love-pink); color: var(--love-pink); }

    /* --- 共通オーバーレイ --- */
    .overlay-base {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        flex-direction: column; justify-content: center; align-items: center;
        backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.5s ease;
        padding: 20px; box-sizing: border-box;
        font-family: monospace; color: var(--matrix-green); z-index: 2000;
    }
    .overlay-base.show { opacity: 1; }

    /* Step 1: インストラクション */
    #instruction-overlay { z-index: 1500; }
    .instruction-box {
        width: 100%; max-width: 400px; padding: 40px 25px;
        border-radius: 4px; text-align: center;
        border: 2px solid var(--matrix-green); background: rgba(0, 20, 0, 0.8);
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        animation: boxPulse 2s infinite alternate;
    }
    .instruction-icon { font-size: 50px; margin-bottom: 20px; color:var(--love-pink); animation: float 2s infinite ease-in-out; }
    .instruction-text { font-size: 18px; line-height: 2; margin-bottom: 30px; color: var(--text-color); font-family: monospace;}
    .highlight-text { color: var(--love-pink); font-weight: bold; font-size: 24px; }

    /* Step 2: アップロード演出 */
    #upload-overlay { z-index: 2100; }
    .upload-stream {
        position: absolute; bottom: 0; left: 50%; width: 2px; height: 100%;
        background: linear-gradient(to top, transparent, var(--matrix-green), transparent);
        animation: uploadFlow 1.5s linear infinite; opacity: 0.7;
    }
    .stream-1 { margin-left: -20px; animation-delay: 0.1s; height: 80%; }
    .stream-2 { margin-left: 0px; animation-duration: 2s; }
    .stream-3 { margin-left: 20px; animation-delay: 0.3s; height: 90%; }
    @keyframes uploadFlow {
        0% { transform: translateY(100%) scaleY(0.5); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: translateY(-100%) scaleY(1.5); opacity: 0; }
    }
    .upload-text-container { height: 60px; display: flex; justify-content: center; align-items: center; z-index: 10; }
    .upload-text {
        font-size: 16px; letter-spacing: 2px; color: var(--matrix-green);
        text-shadow: 0 0 10px var(--matrix-green);
    }
    .fade-text { animation: textFade 2.8s linear forwards; }
    @keyframes textFade { 0% { opacity: 0; transform: translateY(10px); } 20% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-10px); } }

    /* Step 3: ダウンロード */
    #loading-overlay { z-index: 2200; }
    .progress-bar { width: 200px; height: 2px; background: #003300; margin-top: 10px; }
    .progress-fill { width: 0%; height: 100%; background: var(--matrix-green); transition: width 0.2s; }

    /* Step 4: 結果モーダル */
    #result-area { z-index: 1000; background-color: rgba(0, 0, 0, 0.9); }
    .result-box {
        width: 100%; max-width: 400px; padding: 40px 20px;
        border-radius: 4px; text-align: center; position: relative;
        box-shadow: 0 0 30px rgba(0, 255, 0, 0.2);
        max-height: 70vh; overflow-y: auto; /* 少し縦長に */
        border: 1px solid var(--matrix-green); background: #000;
        transform: scale(0.9); transition: transform 0.4s;
    }
    #result-area.show .result-box { transform: scale(1); }

    /* モード別デザイン */
    .mode-iching { border: 1px solid var(--matrix-green); color: var(--matrix-green); }
    .mode-iching .symbol { color: var(--matrix-green); text-shadow: 0 0 10px var(--matrix-green); font-size: 80px; }
    .mode-god, .mode-override {
        border: 2px solid var(--love-pink); /* 恋愛なのでピンク系に */
        background: linear-gradient(135deg, #2a0015, #000);
        box-shadow: 0 0 60px rgba(255, 105, 180, 0.4);
        animation: borderPulseLove 2s infinite;
    }
    @keyframes borderPulseLove { 0% { border-color: var(--love-pink); } 50% { border-color: #fff; } 100% { border-color: var(--love-pink); } }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    .mode-god .symbol { color: var(--love-pink); text-shadow: 0 0 30px var(--love-pink); }

    /* 共通テキスト */
    .symbol { display: block; margin-bottom: 10px; line-height: 1; }
    .name { font-size: 28px; font-weight: bold; margin: 10px 0; letter-spacing: 0.1em; }
    .sub-name { font-size: 11px; opacity: 0.7; letter-spacing: 1px; margin-bottom: 20px; font-family: monospace; }
    .desc-box {
        text-align: left; font-size: 15px; line-height: 1.8;
        padding: 20px; background: rgba(0, 50, 0, 0.2);
        border: 1px solid rgba(0, 255, 0, 0.2);
        border-radius: 4px; margin-top: 10px;
    }
    
    /* サブ結果表示エリア */
    .sub-result-area {
        margin-top: 25px; padding-top: 15px;
        border-top: 1px dashed rgba(0,255,0,0.3);
        text-align: left; font-size: 12px;
    }
    .sub-result-title { font-weight: bold; margin-bottom: 5px; color: var(--neon-cyan); }

    /* アクションボタン */
    .action-area { width: 100%; max-width: 400px; margin-top: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1001; }
    .action-btn {
        padding: 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; font-size: 14px;
        font-family: monospace;
    }
    .btn-share { background: var(--matrix-green); color: #000; box-shadow: 0 0 10px var(--matrix-green); }
    .btn-x { background: #000; color: #fff; border: 1px solid #fff; }
    .btn-close { background: transparent; color: #888; border: 1px solid #333; }
    /* トップへ戻るボタン */
    .btn-back-top { margin-top:20px; background: transparent; color: #666; border: none; font-size:12px; cursor:pointer; }

</style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<header>
    <h1>恋愛グリッド<div class="subtitle">LOVE ALGORITHM PROTOCOL</div></h1>
    <div class="intro-text">
        <span class="highlight">「恋のバグ、見つけます。」</span><br>
        あなたの恋愛パターンを解析し、隠された運命のソースコードをハッキングします。<br>
        ※ここは恋愛特化の解析空間です。
    </div>
</header>

<div class="container">
    <button class="menu-btn" onclick="initiateDivination('今の関係性', 'Current Status')">
        今の関係性<span>> Status Check</span>
    </button>
    <button class="menu-btn" onclick="initiateDivination('相手の気持ち', 'Target Feelings')">
        相手の気持ち<span>> Scan Target Emotion</span>
    </button>
    <button class="menu-btn" onclick="initiateDivination('今後の展開', 'Future Route')">
        今後の展開<span>> Predict Future</span>
    </button>
    <button class="menu-btn" onclick="initiateDivination('復縁の可能性', 'Reconnect Odds')">
        復縁の可能性<span>> Reconnection Prob.</span>
    </button>
    <button class="menu-btn full-width" onclick="initiateDivination('隠された真実（核心）', 'Deep Love Dive')">
        深層ダイブ（二人の核心）<span>> Execute Deep Dive</span>
    </button>
    <button class="btn-back-top" onclick="location.href='index.html'">← 通常グリッドへ戻る</button>
</div>

<div id="instruction-overlay" class="overlay-base">
    <div class="instruction-box" style="border-color:var(--love-pink);">
        <div class="instruction-icon">💓</div>
        <p class="instruction-text">
            雑念を捨てよ。<br>
            相手の顔を思い浮かべ<br>
            <span class="highlight-text" style="color:var(--love-pink);">三回</span>、名を唱えよ。
        </p>
        <button id="proceed-btn" class="action-btn btn-share" style="background:var(--love-pink); color:#fff; box-shadow:0 0 10px var(--love-pink);" onclick="startUploadSequence()">
            唱えた。接続を開始する。
        </button>
    </div>
</div>

<div id="upload-overlay" class="overlay-base">
    <div class="upload-stream stream-1"></div>
    <div class="upload-stream stream-2"></div>
    <div class="upload-stream stream-3"></div>
    <div class="upload-text-container">
        <div id="upload-text-dynamic" class="upload-text">INITIALIZING...</div>
    </div>
    <div style="font-size:10px; margin-top:10px; opacity:0.7; color:var(--love-pink);">CONNECTING TO LOVE GRID</div>
</div>

<div id="loading-overlay" class="overlay-base">
    <div class="upload-text" style="color:var(--love-pink);">DOWNLOADING RESULT...</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="background:var(--love-pink);"></div></div>
    <div style="font-size:10px; color:var(--love-pink); margin-top:5px;">DECRYPTING FATE MATRIX</div>
</div>

<div id="result-area" class="overlay-base">
    <div id="capture-target" class="result-box">
        <div id="result-content"></div>
    </div>
    <div class="action-area" id="action-buttons" style="display:none;">
        <button onclick="shareImage()" class="action-btn btn-share" style="background:var(--love-pink); color:#fff;">💾 結果を保存</button>
        <div style="display:flex; gap:10px;">
            <a id="btn-x" class="action-btn btn-x" style="flex:1;" target="_blank">𝕏 Post</a>
            <a id="btn-line" class="action-btn" style="flex:1; background:#06c755; color:#fff;" target="_blank">LINE Send</a>
        </div>
        <button onclick="closeResult()" class="action-btn btn-close">Close Terminal</button>
    </div>
</div>

<script>
    /* --- Matrix Rain (共通) --- */
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const katakana = 'ｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ';
    const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const alphabet = katakana + latin;
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = []; for(let i=0; i<columns; i++) drops[i]=1;
    function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0F0'; ctx.font = fontSize + 'px monospace';
        for(let i=0; i<drops.length; i++) {
            const text = alphabet.charAt(Math.floor(Math.random()*alphabet.length));
            ctx.fillText(text, i*fontSize, drops[i]*fontSize);
            if(drops[i]*fontSize > canvas.height && Math.random()>0.975) drops[i]=0;
            drops[i]++;
        }
    }
    setInterval(drawMatrix, 35);
    window.addEventListener('resize', ()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});

    /* --- 占いロジック --- */
    let currentThemeJp="", currentThemeEn="";

    function toggleOverlay(id, show) {
        const overlay = document.getElementById(id);
        if(show){ overlay.style.display="flex"; setTimeout(()=>{overlay.classList.add("show");},10); }
        else{ overlay.classList.remove("show"); setTimeout(()=>{overlay.style.display="none";},500); }
    }

    // Step 1: 開始
    function initiateDivination(themeJp, themeEn) {
        currentThemeJp = themeJp; currentThemeEn = themeEn;
        toggleOverlay("instruction-overlay", true);
    }

    // Step 2: アップロード演出（メッセージ切り替え機能追加）
    function startUploadSequence() {
        toggleOverlay("instruction-overlay", false);
        setTimeout(() => {
            toggleOverlay("upload-overlay", true);
            const textEl = document.getElementById("upload-text-dynamic");
            const messages = ["意識を無にしてください...", "ノイズを排除中...", "対象への接続を確立...", "アップロード完了。"];
            let msgIndex = 0;
            
            textEl.innerText = messages[0];
            textEl.classList.add("fade-text");

            const msgInterval = setInterval(() => {
                msgIndex++;
                if(msgIndex < messages.length) {
                    textEl.classList.remove("fade-text");
                    void textEl.offsetWidth; // リフロー強制
                    textEl.innerText = messages[msgIndex];
                    textEl.classList.add("fade-text");
                } else {
                    clearInterval(msgInterval);
                }
            }, 2500); // 2.5秒ごとに切り替え

            // 合計約10秒後に次へ
            setTimeout(() => {
                clearInterval(msgInterval);
                toggleOverlay("upload-overlay", false);
                setTimeout(() => { divination(currentThemeJp, currentThemeEn); }, 500);
            }, 10000); 
        }, 300);
    }

    // Step 3: ダウンロード
    function divination(themeJp, themeEn) {
        const fill = document.getElementById("progress-fill");
        toggleOverlay("loading-overlay", true);
        fill.style.width = "0%";
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.floor(Math.random() * 15);
            if(progress > 100) progress = 100;
            fill.style.width = `${progress}%`;
            if(progress === 100) {
                clearInterval(interval);
                setTimeout(() => {
                    toggleOverlay("loading-overlay", false);
                    showResult(themeJp, themeEn);
                }, 500);
            }
        }, 150);
    }

    /* --- 恋愛用データセット（全64卦書き下ろし＋神17柱流用） --- */
    // ※神データは既存のものを流用し、威厳を保つ
    const godsData = [
        { n: "国常立尊", r: "くにのとこたち", d: "【Kernel】<br>OSの中核。基盤確立。ここが揺らぐと全て落ちる。最強のセキュリティを敷け。" },
        { n: "豊雲野神", r: "とよくもの", d: "【Cloud】<br>クラウドの始祖。物理サーバーを捨てよ。可能性は空（くう）にある。" },
        { n: "宇比地邇神", r: "うひじに", d: "【Bit / Byte】<br>0と1の泥。情報の最小単位。ここから全てのプログラムが始まる。" },
        { n: "須比智邇神", r: "すひちに", d: "【Blockchain】<br>ブロックの積み重ね。改竄不可能な履歴が信頼を作る。継続せよ。" },
        { n: "角杙神", r: "つのぐい", d: "【Hello World】<br>最初の出力。画面に文字が出た時の感動。初期衝動を忘れるな。" },
        { n: "活杙神", r: "いくぐい", d: "【Runtime】<br>実行環境。生命力が走っている。今ならどんな処理も高速完了する。" },
        { n: "意富斗能地神", r: "おおとのじ", d: "【Logic】<br>論理演算。IF文の分岐。感情を排し、ロジックでルートを確定せよ。" },
        { n: "大斗乃弁神", r: "おおとのべ", d: "【Interface】<br>ユーザーへの優しさ。入力フォームの親切さ。受け入れる心がバグを減らす。" },
        { n: "於母陀流神", r: "おもだる", d: "【Clean Code】<br>美しいコード。バグがない。コメントがなくても読める完全な調和。" },
        { n: "阿夜訶志古泥神", r: "あやかしこね", d: "【Algorithm】<br>畏敬の念。人智を超えたアルゴリズム。AIのブラックボックスを信じよ。" },
        { n: "伊邪那岐命", r: "いざなぎ", d: "【Developer】<br>創造主。新しいサービスを生む。レガシーコードを捨て、新規開発せよ。" },
        { n: "伊邪那美命", r: "いざなみ", d: "【Recovery】<br>リカバリ。死（ダウン）からの復旧。システムはより強固になって再起動する。" },
        { n: "天之常立神", r: "あめのとこたち", d: "【Server Permanence】<br>永続化。セッションは切れない。あなたの志はアーカイブされた。" },
        { n: "宇摩志阿斯訶備比古遅神", r: "うましあしかびひこじ", d: "【Scalability】<br>スケーラビリティ。爆発的拡張。サーバーを増強せよ、アクセスが急増する。" },
        { n: "神産巣日神", r: "かみむすび", d: "【Patch & Merge】<br>修正と統合。コンフリクトは解消される。安心してマージせよ。" },
        { n: "高御産巣日神", r: "たかみむすび", d: "【Admin Guide】<br>上位存在からのドキュメント。直感という名の通知を見逃すな。" },
        { n: "天之御中主神", r: "あめのみなかぬし", d: "【Root User】<br>特権ID。全権限掌握。あなたがルールだ。コマンドを実行せよ。" }
    ];
    // 恋愛用64卦データ
    const ichingDataLove = [
        { k: "乾為天", r: "けんいてん", d: "【Love Mode: BOLD】圧倒的な行動力。迷わずアプローチせよ。あなたがリードすることで関係は劇的に進展する。自信が鍵。" },
        { k: "坤為地", r: "こんいち", d: "【Love Mode: RECEPTIVE】受け身の美学。今は自分から動かず、相手の出方を待つこと。包容力が最高の魅力を生む。" },
        { k: "水雷屯", r: "すいらいちゅん", d: "【Status: BUFFRING】恋の始まりは重たい。障害や迷いがあるが、焦らず信頼関係の基礎を固める時期。春を待て。" },
        { k: "山水蒙", r: "さんすいもう", d: "【Status: FOGGY】相手の本心が見えない霧の中。独りよがりな解釈は危険。信頼できる友人に相談を。" },
        { k: "水天需", r: "すいてんじゅ", d: "【Action: WAIT】待機せよ。焦って連絡しても逆効果。自分磨きをしながら、相手からのアクションを待つのが最善。" },
        { k: "天水訟", r: "てんすいしょう", d: "【Warning: CONFLICT】喧嘩や対立の予感。自分の正しさを主張しすぎると関係が破綻する。一歩引く勇気を。" },
        { k: "地水師", r: "ちすいし", d: "【Strategy: TACTICS】恋の駆け引きが必要。感情に流されず、冷静に戦略を練ること。協力者を得るのも吉。" },
        { k: "水地比", r: "すいちは", d: "【Status: HARMONY】親密な関係。心が通じ合っている。素直な気持ちを伝えることで、より深い絆が生まれる。" },
        { k: "風天小畜", r: "ふうてんしょうちく", d: "【Status: PAUSED】少し停滞気味。相手の反応が鈍い。今は無理に進めようとせず、現状維持で様子を見る時期。" },
        { k: "天沢履", r: "てんたくり", d: "【Warning: RISKY】危険な恋の予感。スリルはあるが、一歩間違えば火傷する。礼儀と慎重さを忘れずに。" },
        { k: "地天泰", r: "ちてんたい", d: "【Result: PERFECT MATCH】最高の組み合わせ。お互いの心が通じ合い、愛が深まる絶好調の時期。この幸せを享受せよ。" },
        { k: "天地否", r: "てんちひ", d: "【Status: DISCONNECTED】心が離れている。すれ違いが多く、話が通じない。今は冷却期間が必要かもしれない。" },
        { k: "天火同人", r: "てんかどうじん", d: "【Action: FRIENDSHIP】まずは友人として信頼を築くこと。共通の趣味や話題が、恋人へのステップとなる。" },
        { k: "火天大有", r: "かてんたいゆう", d: "【Status: POPULAR】モテ期到来。多くの異性から注目される。高飛車にならず、謙虚な態度が本命を引き寄せる。" },
        { k: "地山謙", r: "ちざんけん", d: "【Strategy: HUMILITY】謙虚さが最大の武器。相手を立て、控えめな態度で接することで、あなたの評価は急上昇する。" },
        { k: "雷地予", r: "らいちよ", d: "【Status: EXCITED】恋の予感に胸が高鳴る。楽しい計画を立てよう。準備を万全にすれば、デートは成功する。" },
        { k: "沢雷随", r: "たくらいずい", d: "【Action: FOLLOW】相手のペースに合わせること。無理な要求はせず、流れに身を任せることで関係はスムーズに進む。" },
        { k: "山風蠱", r: "さんぷうこ", d: "【Warning: CORRUPTION】関係がマンネリ化、あるいは腐敗している。隠し事や不満を清算し、リセットする必要がある。" },
        { k: "地沢臨", r: "ちたくりん", d: "【Action: APPROACH】絶好のチャンス到来。希望が叶う時。ためらわず積極的にアプローチして愛を勝ち取れ。" },
        { k: "風地観", r: "ふうちは", d: "【Action: OBSERVE】静観せよ。相手をよく観察し、理解を深める時期。表面的な魅力だけでなく内面を見ること。" },
        { k: "火雷噬嗑", r: "からいぜいご", d: "【Action: BREAKTHROUGH】障害を排除せよ。ライバルや誤解など、二人の間の邪魔なものを断固として取り除く時。" },
        { k: "山火賁", r: "さんかひ", d: "【Strategy: APPEARANCE】外見を磨くことが効果的。おしゃれをしてデートに臨め。ただし中身も伴うように努力を。" },
        { k: "山地剥", r: "さんちはく", d: "【Warning: COLLAPSE】関係崩壊の危機。相手の心が離れかけている。今は無理に引き留めず、静かに身を守る時。" },
        { k: "地雷復", r: "ちらいふく", d: "【Result: RESTART】復縁の兆し。終わったと思った恋が再燃する可能性。冬が終わり春が来るように、愛が戻ってくる。" },
        { k: "天雷無妄", r: "てんらいむもう", d: "【Strategy: HONESTY】駆け引き無用。ありのままの自分を見せること。嘘や計算は逆効果になる。誠実さが鍵。" },
        { k: "山天大畜", r: "さんてんたいちく", d: "【Action: CHARGE】愛のエネルギーを溜め込む時。今はアプローチせず、自分磨きに集中し、来るべき時に備えよ。" },
        { k: "山雷頤", r: "さんらいい", d: "【Warning: WATCH MOUTH】言葉に注意。不用意な一言が関係を悪化させる。相手への思いやりある言葉を選んで。" },
        { k: "沢風大過", r: "たくふうたいか", d: "【Warning: OVERLOAD】愛が重すぎる。相手にプレッシャーを与えていないか？ 少し距離を置き、冷静になる必要がある。" },
        { k: "坎為水", r: "かんいすい", d: "【Status: DIFFICULT】恋の悩みは深い。泥沼状態。もがけばもがくほど深みにハマる。今は耐え忍ぶしかない。" },
        { k: "離為火", r: "りいか", d: "【Status: PASSION】燃え上がるような情熱的な恋。ただし熱しやすく冷めやすい。相手を見極める知性も必要。" },
        { k: "沢山咸", r: "たくざんかん", d: "【Result: CHEMISTRY】ビビッときた直感を信じて。理屈抜きで惹かれ合う運命の相手。心の声に従って行動せよ。" },
        { k: "雷風恒", r: "らいふうこう", d: "【Status: STABLE】安定した関係。派手さはないが、穏やかな愛が長く続く。日常の小さな幸せを大切に。" },
        { k: "天山遯", r: "てんざんとん", d: "【Action: RETREAT】今は引くべき時。押してもダメなら引いてみろ。一時的に距離を置くことで、相手の関心を引ける。" },
        { k: "雷天大壮", r: "らいてんたいそう", d: "【Warning: RUSH】勢い余って暴走しないように。相手の気持ちを無視したアプローチは失敗する。自制心を持って。" },
        { k: "火地晋", r: "かちしん", d: "【Status: LEVEL UP】関係がトントン拍子に進展する。周りからの祝福も期待できる。自信を持って進んで。" },
        { k: "地火明夷", r: "ちかめいい", d: "【Action: HIDE】今は想いを隠す時。相手にパートナーがいるなど、状況が悪い。耐え忍び、チャンスを待て。" },
        { k: "風火家人", r: "ふうかかじん", d: "【Status: AT HOME】家族のような温かい関係。結婚を意識するのにも良い時期。内側を固めることで愛が深まる。" },
        { k: "火沢睽", r: "かたくけい", d: "【Status: MISMATCH】相性が悪いかもしれない。価値観の違いで対立しがち。無理に合わせようとせず、違いを認めること。" },
        { k: "水山蹇", r: "すいざんけん", d: "【Status: BLOCKED】八方塞がり。どう動いても上手くいかない。今は無理に進まず、信頼できる人に助けを求めて。" },
        { k: "雷水解", r: "らいすいかい", d: "【Result: SOLVED】誤解が解ける、悩みが解決する時。仲直りのチャンス。早めに行動してわだかまりを解消せよ。" },
        { k: "山沢損", r: "さんたくそん", d: "【Strategy: SACRIFICE】相手のために尽くす時。今の献身が、将来大きな愛となって返ってくる。見返りを求めないこと。" },
        { k: "風雷益", r: "ふうらいえき", d: "【Status: BENEFIT】二人の関係がプラスに働く。互いに成長できる良い関係。積極的に交際を進めて吉。" },
        { k: "沢天夬", r: "たくてんかい", d: "【Action: DECIDE】決断の時。曖昧な関係に終止符を打て。告白するか、別れるか。はっきりさせる必要がある。" },
        { k: "天風姤", r: "てんぷうこう", d: "【Warning: TEMPTATION】予期せぬ出会い、または浮気の誘惑。魅力的な相手だが危険が潜んでいる。深入りは禁物。" },
        { k: "沢地萃", r: "たくちすい", d: "【Action: GATHER】人が集まる場所に出会いがある。パーティーやイベントに積極的に参加して。人気運も上昇中。" },
        { k: "地風升", r: "ちふうしょう", d: "【Status: GROWING】愛がゆっくりと、しかし確実に育っている。焦らず時間をかけることで、関係はより強固になる。" },
        { k: "沢水困", r: "たくすいこん", d: "【Status: EXHAUSTED】恋に疲れて動けない。何を言っても信じてもらえない。今は静かに休養し、気力が戻るのを待て。" },
        { k: "水風井", r: "すいふうせい", d: "【Status: DEEP LOVE】井戸のように深い愛。変わらぬ献身的な態度が、最終的に相手の心を動かす。" },
        { k: "沢火革", r: "たくかかく", d: "【Action: REVOLUTION】変革の時。今までのアプローチや関係性をガラリと変える必要がある。過去を捨てて。" },
        { k: "火風鼎", r: "かふうてい", d: "【Status: ESTABLISHED】二人の関係が確固たるものになる。協力し合うことで安定した未来が築ける。結婚の可能性も。" },
        { k: "震為雷", r: "しんいらい", d: "【Status: SHOCK】衝撃的な出来事の予感。サプライズやハプニングに動揺するが、冷静に対処すれば問題ない。" },
        { k: "艮為山", r: "ごんいざん", d: "【Action: STOP】今は動くな。現状維持に努めるべき時。無理に動くと事態が悪化する。静止して時を待て。" },
        { k: "風山漸", r: "ふうざんぜん", d: "【Strategy: STEP BY STEP】順序を守ること。いきなり結果を求めず、友達から少しずつ関係を深めていくのが正解。" },
        { k: "雷沢帰妹", r: "らいたくきまい", d: "【Warning: ERROR】順序が逆。体の関係から始まるなど、手順を間違うと破綻する。目先の欲に流されないで。" },
        { k: "雷火豊", r: "らいかほう", d: "【Status: PEAK】愛の絶頂期。今が一番幸せな時かもしれない。この瞬間を大切にしつつ、将来への備えも忘れずに。" },
        { k: "火山旅", r: "かざんりょ", d: "【Status: UNSTABLE】不安定な関係。相手の心が定まらない、または遠距離恋愛など。寂しさを感じる旅の途中。" },
        { k: "巽為風", r: "そんいふう", d: "【Strategy: FLEXIBILITY】風のように柔軟に。相手の意見や状況に合わせて対応することで、心に入り込める。" },
        { k: "兌為沢", r: "だいたく", d: "【Action: SMILE】笑顔と会話が恋の特効薬。楽しいコミュニケーションを心がけることで、相手も心を開いてくれる。" },
        { k: "風水渙", r: "ふうすいかん", d: "【Result: RELEASE】悩みが解消される。こだわりを捨て、心を解き放つことで新しい恋の可能性が見えてくる。" },
        { k: "水沢節", r: "すいたくせつ", d: "【Strategy: LIMIT】親しき仲にも礼儀あり。節度ある付き合いが、関係を長続きさせる秘訣。束縛しすぎないこと。" },
        { k: "風沢中孚", r: "ふうたくちゅうふ", d: "【Status: SINCERITY】真心が通じる時。駆け引きなしの誠実な態度が、相手の心に深く響く。信じ合う心。" },
        { k: "雷山小過", r: "らいざんしょうか", d: "【Warning: HUMBLE】高望みは失敗のもと。理想を押し付けすぎず、少し控えめなくらいが丁度いい。" },
        { k: "水火既済", r: "すいかきせい", d: "【Status: COMPLETE】関係は完成された。これ以上の進展は望みにくいが、今の安定した状態を維持する努力を。" },
        { k: "火水未済", r: "かすいびせい", d: "【Status: INCOMPLETE】まだ未完成な関係。だが、それは未来への可能性に満ちているということ。これからが本番。" }
    ];

    function makeRuby(kanji, kana) { return `<ruby>${kanji}<rt>${kana}</rt></ruby>`; }
    function generateXUrl(text) { return `https://twitter.com/intent/tweet?text=${encodeURIComponent(text + "\n\n#恋愛グリッド #マトリックス占い")}&url=${encodeURIComponent(location.href)}`; }
    function generateLineUrl(text) { return `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(location.href)}&text=${encodeURIComponent(text)}`; }

    // Step 4: 結果表示（サブ結果追加）
    function showResult(themeJp, themeEn) {
        const modal = document.getElementById("result-area");
        const box = document.getElementById("capture-target");
        const content = document.getElementById("result-content");
        const actions = document.getElementById("action-buttons");

        box.className = "result-box"; 
        const primaryRoll = Math.floor(Math.random() * 81) + 1;
        
        // ★追加機能：サブ結果（潜在的可能性）の抽選★
        let subRoll;
        do { subRoll = Math.floor(Math.random() * 64); } while (subRoll === (primaryRoll - 1)); // メインと被らないように
        const subItem = ichingDataLove[subRoll];

        let htmlContent = ""; let shareText = "";

        // メイン結果の生成処理
        if (primaryRoll > 64) {
            const god = godsData[primaryRoll - 65];
            box.classList.add("mode-god");
            shareText = `【Love Code: GOD】${god.n}が降臨。恋の運命が強制的に書き換わりました。`;
            htmlContent = `
                <div class="symbol">⛩️</div>
                <div class="name" style="color:var(--love-pink);">${makeRuby(god.n, god.r)}</div>
                <div class="sub-name">ROOT ACCESS: GRANTED / ${themeEn}</div>
                <div class="desc-box" style="border:2px solid var(--love-pink); color:var(--love-pink);">
                    ${god.d}
                </div>
            `;
        } else {
            const ichingItem = ichingDataLove[primaryRoll - 1];
            const overrideRoll = Math.floor(Math.random() * 64) + 1;
            if (overrideRoll <= 17) {
                const god = godsData[Math.floor(Math.random() * 17)];
                box.classList.add("mode-override");
                shareText = `【Override】${ichingItem.k}の恋路に${god.n}が介入しました。`;
                htmlContent = `
                    <div class="symbol" style="color:var(--love-pink);">⚡️</div>
                    <div class="name">${makeRuby(ichingItem.k, ichingItem.r)}</div>
                    <div class="sub-name">LOG: HEXAGRM ${primaryRoll} / ${themeEn}</div>
                    <div class="desc-box" style="opacity:0.7; text-decoration:line-through; font-size:12px;">
                        Initial: ${ichingItem.d.substring(0, 15)}...
                    </div>
                    <div style="color:var(--love-pink); font-weight:bold; margin:5px 0;">>> DIVINE INTERVENTION</div>
                    <div class="desc-box" style="border:1px solid var(--love-pink); background:rgba(50,0,20,0.5);">
                        <strong>${makeRuby(god.n, god.r)} Protocol:</strong><br>
                        ${god.d}
                    </div>
                `;
            } else {
                box.classList.add("mode-iching");
                shareText = `【Result】${ichingItem.k}。${themeJp}の解析結果が出ました。`;
                htmlContent = `
                    <div class="symbol">☯</div>
                    <div class="name">${makeRuby(ichingItem.k, ichingItem.r)}</div>
                    <div class="sub-name">STATUS: ${themeEn}</div>
                    <div class="desc-box">
                        ${ichingItem.d}
                    </div>
                `;
            }
        }

        // ★追加機能：サブ結果の表示エリアを追加★
        htmlContent += `
            <div class="sub-result-area">
                <div class="sub-result-title">> 潜在的な可能性（Sub Route）を検知:</div>
                【${subItem.k}】 ${subItem.d.substring(subItem.d.indexOf("】")+1)}
            </div>
        `;

        content.innerHTML = htmlContent;
        document.getElementById("btn-x").href = generateXUrl(shareText);
        document.getElementById("btn-line").href = generateLineUrl(shareText);
        
        toggleOverlay("result-area", true);
        setTimeout(() => { actions.style.display = "flex"; }, 50);
    }

    async function shareImage() {
        const target = document.getElementById("capture-target");
        try {
            const canvas = await html2canvas(target, { backgroundColor: '#000', scale: 2 });
            const link = document.createElement("a"); link.download = "love_grid_result.png";
            link.href = canvas.toDataURL(); link.click();
        } catch (e) { alert("Error: " + e); }
    }
    function closeResult() { toggleOverlay("result-area", false); const actions = document.getElementById("action-buttons"); setTimeout(() => { actions.style.display = "none"; }, 500); }
</script>
</body>
</html>
